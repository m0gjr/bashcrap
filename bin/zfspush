#!/bin/bash -e

homeds=$(zfs mount | awk '$2 == "/home" {print $1}')

if [ "$(basename "$0")" = "zfspull" ]
then
	echo pull
	shost="${shost:-home}"
	dhost="${dhost:-localhost}"
	sds="${sds:-rustbucket/home}"
	dds="${dds:-$homeds}"
else
	echo push
	shost="${shost:-localhost}"
	dhost="${dhost:-server}"
	sds="${sds:-$homeds}"
	dds="${dds:-rustbucket/home}"
fi

src=$(ssh $shost zfs list -t snapshot -Ho name $sds | tail -n1 | cut -d'@' -f2)
dst=$(ssh $dhost zfs list -t snapshot -Ho name $dds | tail -n1 | cut -d'@' -f2)

if [ -z $dst ]
then
	ssh $shost "zfs send -nv $sds@$src"
	ssh $shost "zfs send $sds@$src" | pv | ssh $dhost "zfs receive $dds" || rollback=true
else
	ssh $shost "zfs send -nvi $sds@$dst $sds@$src"
	ssh $shost "zfs send -i $sds@$dst $sds@$src" | pv | ssh $dhost "zfs receive $dds" || rollback=true
fi

if [ -n "$rollback" ]
then
	echo rolling back $dhost to $dds@$dst
	echo enter to proceed
	read
	ssh $dhost "zfs rollback $dds@$dst"
	ssh $shost "zfs send -i $sds@$dst $sds@$src" | pv | ssh $dhost "zfs receive $dds"
fi
