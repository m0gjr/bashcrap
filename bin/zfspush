#!/bin/bash -e

homeds=$(zfs mount | awk '$2 == "/home" {print $1}')

shost="${shost:-localhost}"
dhost="${dhost:-server}"
sds="${sds:-$homeds}"
dds="${dds:-rustbucket/home}"

src=$(ssh $shost zfs list -t snapshot -Ho name $sds | tail -n1 | cut -d'@' -f2)
dst=$(ssh $dhost zfs list -t snapshot -Ho name $dds | tail -n1 | cut -d'@' -f2)

ssh $shost "zfs send -nvi $sds@$dst $sds@$src"
ssh $shost "zfs send -i $sds@$dst $sds@$src" | pv | ssh $dhost "zfs receive $dds"
