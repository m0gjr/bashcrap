#!/usr/bin/python3

import mullvad
import sys
import os

servers=mullvad.get_servers()
servers=mullvad.filter(sys.argv,servers)
server=mullvad.pick_server(servers)

dir=""

try:
	with open(os.path.join(dir,'mullvad-template'),'r') as file:
		template=file.read()
except:
	pass
else:
	if os.path.exists(os.path.join(dir,"vpn.conf")):
		with open(os.path.join(dir,"vpn.conf"),'w') as file:
			file.write(template)
			file.write("PublicKey = "+server["pubkey"]+"\n")
			file.write("Endpoint = "+server["ipv4_addr_in"]+":51820"+"\n")
			for server in servers:
				file.write('\n[Peer]\n')
				file.write("PublicKey = "+server["pubkey"]+"\n")
				file.write("Endpoint = "+server["ipv4_addr_in"]+":51820"+"\n")
		os.chmod(os.path.join(dir,"vpn.conf"),0o600);
	else:
		servername="mlvd"+server["hostname"].replace('-wg-','').replace('-','')
		with open(os.path.join(dir,servername+".conf"),'w') as file:
			file.write(template)
			file.write("PublicKey = "+server["pubkey"]+"\n")
			file.write("Endpoint = "+server["ipv4_addr_in"]+":51820"+"\n")
		os.chmod(os.path.join(dir,servername+".conf"),0o600);
